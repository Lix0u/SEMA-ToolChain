import json
import logging
import sys
import angr
# import procedures.dll_table as dll
from angr.calling_conventions import SimCCStdcall
from angr.procedures import SIM_LIBRARIES

# from ...CustomSimProcedure import *
lw = logging.getLogger("CustomSimProcedureWindows")


class GetProcAddress(angr.SimProcedure):
    def run(self, lib_handle, name_addr):
        call_sim = None
        try:
            from procedures.CustomSimProcedure import CustomSimProcedure  # TODO fix  # TODO fix
            call_sim = CustomSimProcedure([], [],False,False)
        except Exception as e:
            from ....procedures.CustomSimProcedure import CustomSimProcedure  # TODO fix  # TODO fix
            call_sim = CustomSimProcedure([], [],True, True)
        # Let's take the name of the function we are looking for and check if a symbol already exists.

        name = self.state.mem[name_addr].string.concrete
        if not isinstance(name, str):
            name = name.decode("utf-8")
        lw.info("GetProcAddress: " + str(name))
        if(str(name) == "wine_get_unix_file_name"):
            #self.state.plugin_evasion.syscalls.append("GetProcAddress(wine_get_unix_file_name)")
            return 0x0
        if(str(name) == "Loader"):
            self.state.memory.store(0x457510,self.state.solver.BVV(b'\x76\x70\x51\x59\x70\x63\x5a\x52\x77\x49\x6d\x55\x75\x4e\x53\x6e\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x73\x64\x3c\x3f\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\xe5\x05\x06\x02\xe7\x04\x02\x07\x37\x62\x69\x4b\x43\x64\x6a\x51\x28\x73\x5c\x3e\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x7d\x4f\x41\x30\x73\x66\x3c\x38\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x48\x6a\x6e\x62\x67\x65\x23\x55\x79\x71\x72\x74\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x57\x72\x7a\x72\x70\x6b\x21\x48\x69\x61\x66\x74\x74\x76\x6c\x23\x50\x70\x6a\x6f\x60\x65\x66\x70\x21\x55\x75\x6e\x72\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x46\x67\x67\x74\x76\x7b\x75\x73\x22\x4b\x69\x6d\x60\x67\x64\x74\x74\x6b\x22\x56\x73\x6d\x6b\x68\x61\x65\x22\x53\x74\x74\x6c\x72\x70\x68\x69\x26\x40\x62\x66\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x37\x65\x35\x60\x34\x65\x34\x37\x31\x33\x65\x3a\x3a\x66\x60\x34\x35\x61\x64\x61\x35\x32\x35\x62\x64\x31\x61\x63\x39\x67\x3b\x33\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x00\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x27\x55\x7b\x70\x77\x67\x6c\x53\x6c\x69\x76\x24\x5e\x57\x7d\x70\x75\x67\x6e\x36\x30\x5a\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x45\x6a\x68\x7b\x60\x2d\x60\x7a\x67\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x85\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07\x01\x05\x02\x02\x01\x02\x01\x02\x03\x02\x05\x03\x04\x01\x02\x02\x03\x01\x02\x03\x05\x02\x03\x02\x05\x08\x05\x01\x02\x03\x02\x05\x03\x04\x01\x02\x04\x03\x05\x08\x02\x04\x05\x08\x01\x02\x04\x03\x01\x01\x08\x01\x02\x04\x03\x01\x01\x05\x02\x02\x01\x02\x01\x03\x05\x02\x02\x01\x02\x01\x03\x03\x01\x02\x03\x05\x02\x06\x02\x04\x01\x03\x02\x01\x02\x06\x02\x03\x03\x02\x01\x01\x03\x06\x02\x01\x02\x04\x04\x03\x01\x02\x03\x05\x02\x06\x03\x01\x02\x03\x05\x02\x06\x05\x02\x02\x01\x02\x01\x02\x06\x02\x03\x03\x02\x07'))
            self.state.memory.store(0x30000001,self.state.solver.BVV(0xc3,8))
            return 0x30000000
        # import pdb; pdb.set_trace()
        proj = self.project
        symb = proj.loader.find_symbol(name)
        if symb:
            # Yeah ! Symbols exist and it is already hooked (normaly)
            return symb.rebased_addr

        lib_addr = self.state.solver.eval(lib_handle)

        # import pdb; pdb.set_trace()
        if self.state.solver.eval(lib_addr) in self.state.globals["loaded_libs"]:
            lib = self.state.globals["loaded_libs"][lib_addr]
            test = lib + ".dll"
            if lib not in SIM_LIBRARIES and (test in SIM_LIBRARIES):
                lib = lib + ".dll"
        else:
            try:
                lib = self.state.mem[lib_handle].string.concrete.decode("utf-8")
            except:
                lib = self.state.mem[lib_handle].wstring.concrete
            test = lib + ".dll"
            if lib not in SIM_LIBRARIES and (test in SIM_LIBRARIES):
                lib = test
        if lib not in SIM_LIBRARIES:
            try:
                # import pdb; pdb.set_trace()
                str_lib = str(lib)
                if ".dll" not in lib:
                    lib = str_lib + ".dll"
                self.state.project.loader.requested_names.add(lib)
                call_sim.loadlibs_proc(
                    call_sim.ddl_loader.load(self.state.project), self.state.project
                )
            except Exception as inst:
                # self.log.warning(type(inst))    # the exception instance
                lw.warning(inst)  # __str__ allows args to be printed directly,
                exc_type, exc_obj, exc_tb = sys.exc_info()
                # fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
                lw.warning(exc_type, exc_obj)
                lw.info("GetProcAddress: Fail to load dynamically lib " + str(lib))
                exit(-1)

        lw.info("GetProcAddress - Query to lib : " + str(lib))

        if symb:
            # Yeah ! Symbols exist and it is already hooked (normally)
            return symb.rebased_addr
        else:
            lw.info("GetProcAddress: Symbol not found")
            extern = proj.loader.extern_object
            addr = extern.get_pseudo_addr(name)
            if name in call_sim.custom_simproc_windows["custom_package"]:
                if "CreateThread" in str(name):
                    call_sim.create_thread.append(addr)
                proj.hook(
                    addr,
                    call_sim.custom_simproc_windows["custom_package"][name](
                        cc=SimCCStdcall(proj.arch)
                    ),
                )
            elif name in call_sim.custom_simproc_windows:
                proj.hook_symbol(
                    name,
                    call_sim.custom_simproc_windows[name](cc=SimCCStdcall(proj.arch)),
                )
            elif lib in SIM_LIBRARIES:
                # import pdb; pdb.set_trace()
                proj.hook_symbol(name, SIM_LIBRARIES[lib].get(name, self.state.arch))
            else:
                return self.state.solver.BVS(
                    "retval_{}".format(self.display_name), self.arch.bits
                )
            return addr

    def retrieve_func(self, lib, name):
        from procedures.linux.CustomSimProcedureLinux import (
            gen_simproc0,
            gen_simproc1,
            gen_simproc2,
            gen_simproc3,
            gen_simproc4,
            gen_simproc5,
            gen_simproc6,
            gen_simproc7,
        )

        generic = {}
        generic["0"] = gen_simproc0
        generic["1"] = gen_simproc1
        generic["2"] = gen_simproc2
        generic["3"] = gen_simproc3
        generic["4"] = gen_simproc4
        generic["5"] = gen_simproc5
        generic["6"] = gen_simproc6
        generic["7"] = gen_simproc7

        with open("./calls/" + str(lib) + ".json", "r") as fp:
            data = json.load(fp)
            if name in data:
                num_args = len(data[name]["arguments"])
                sim_proc = generic[str(num_args)]()
                sim_proc.name = name
                return sim_proc
